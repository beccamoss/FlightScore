{% extends 'base.html' %}
{% block content %}
<div class="row">
<div class="col-lg-8 col-lg-offset-2 col-med-8 col-med-offset-2 col-sm-8 col-sm-offset-2">
<h1>FlightScore</h1> 
<h3>2017 Average FlightScore Between Airports</h3>
</div>
</div>
<div class="row">
<div class="col-lg-8 col-lg-offset-1 col-med-8 col-med-offset-1 col-sm-8 col-sm-offset-1">
  <table class='table'>
      <tr><td>
        <div id="chart"></div>
      </td>
      <td>
        <table id="TopFlightScores"></table>
          <script>
                let allScores = {{ all_scores|tojson }};
                let tableHtml = "<thead><th>Airports By FlightScore</th></thead>";
                for (var i=0; i < allScores.length; i++) {
                  tableHtml += "<tr><td>" + allScores[i][1] + " (" + allScores[i][0] + ")</td>";
                  tableHtml += "<td>" + allScores[i][2] + "</td></tr>";
                }
                $("#TopFlightScores").html(tableHtml)
          </script>
      </td></tr>
    </table>
</div>
</div>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>
var num_flights = {{ vol_flights }};
var score = {{ score }};

    ////////////////////////////////////////////////////////////
    //////////////////////// Set-Up ////////////////////////////
    ////////////////////////////////////////////////////////////
    var margin = {left:10, top:10, right:10, bottom:10},
      width =  750, // more flexibility: Math.min(window.innerWidth, 1000)
      height =  750, // same: Math.min(window.innerWidth, 1000)
      innerRadius = Math.min(width, height) * .39,
      outerRadius = innerRadius * 1.1;

    var colors = ["#301E1E", "#083E77", "#342350", "#567235", "#8B161C", 
                  "#DF7C00", "#669999", "#F26223", "ac7339", "b8b894"],
        names = ["ATL", "LAX", "ORD", "DFW", "JFK", "DEN", "SFO", "LAS", "SJC", "SEA"],
        opacityDefault = 0.8;
      
    ////////////////////////////////////////////////////////////
    /////////// Create scale and layout functions //////////////
    ////////////////////////////////////////////////////////////

    var colors = d3.scaleOrdinal()
        .domain(d3.range(names.length))
      .range(colors);

    var chord = d3.chord()
      .padAngle(.02)
      .sortChords(d3.descending)

      var arc = d3.arc()
      .innerRadius(innerRadius*1.01)
      .outerRadius(outerRadius);

    var path = d3.ribbon()
    .radius(innerRadius);

  ////////////////////////////////////////////////////////////
  ////////////////////// Create SVG //////////////////////////
  ////////////////////////////////////////////////////////////
  
  var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + (width/2 + margin.left) + "," + (height/2 + margin.top) + ")")
    .datum(chord(score));

  ////////////////////////////////////////////////////////////
  ////////////////// Draw outer Arcs /////////////////////////
  ////////////////////////////////////////////////////////////

  var outerArcs = svg.selectAll("g.group")
    .data(function(chords) { return chords.groups; })
    .enter().append("g")
    .attr("class", "group")
    .on("mouseover", fade(.1))
    .on("mouseout", fade(opacityDefault))

  ////////////////////////////////////////////////////////////
  ////////////////////// Append names ////////////////////////
  ////////////////////////////////////////////////////////////

  //Append the label names INSIDE outside
  outerArcs.append("path")
    .style("fill", function(d) { return colors(d.index); })
    .attr("id", function(d, i) { return "group" + d.index; })
    .attr("d", arc);

   outerArcs.append("text")
           .attr("x", 6)
           .attr("dy", 18)
           .append("textPath")
           .attr("href", function(d) { return "#group" + d.index;})
           .text(function(chords, i){
              var weightedScores = sumFlights = num_legs = 0;
              for (j=0; j<num_flights.length; j++) {
                  weightedScores += (score[i][j] + score[j][i]);
                  if (score[i][j] != 0)
                    num_legs += 2
              }
              return names[i] + ": " + (weightedScores / num_legs).toFixed(0);})
           .style("fill", "white");

// Add a mouseover title.
  outerArcs.append("title").text(function(d, i) {
    var weightedScores = sumFlights = num_legs = 0;
    for (j=0; j<num_flights.length; j++) {
        weightedScores += (score[i][j] + score[j][i]);
        if (score[i][j] != 0)
          num_legs += 2
    }
    return (weightedScores / num_legs).toFixed(0) + ": Average FlightScore";
  });

  ////////////////////////////////////////////////////////////
  ////////////////// Draw inner chords ///////////////////////
  ////////////////////////////////////////////////////////////

  innerChords = svg.selectAll("path.chord")
    .data(function(chords) { return chords; })
    .enter().append("path")
    .attr("class", "chord")
    .style("fill", function(d) { return colors(d.source.index); })
    .style("opacity", opacityDefault)
    .attr("d", path)
    .on("mouseover", mouseoverChord)
    .on("mouseout", mouseoutChord);

    // Add a mouseover title.
  innerChords.append("title").text(function(d, i) {
  
    return d.source.value.toFixed(0) + " FlightScore from  " + names[d.source.index]+ "\n" + d.target.value.toFixed(0) + " FlightScore From " + names[d.target.index];
  });

  ////////////////////////////////////////////////////////////
  ////////////////// Extra Functions /////////////////////////
  ////////////////////////////////////////////////////////////
  //Highlight hovered over chord
  function mouseoverChord(d,i) {

    //Decrease opacity to all
    svg.selectAll("path.chord")
      .transition()
      .style("opacity", 0.1);
    //Show hovered over chord with full opacity
    d3.select(this)
      .transition()
          .style("opacity", 1);
    // debugger;
  }
  //Bring all chords back to default opacity
  function mouseoutChord(d) {
    //Set opacity back to default for all
    svg.selectAll("path.chord")
      .transition()
      .style("opacity", opacityDefault);
    }      //function mouseoutChord


  //Returns an event handler for fading a given chord group.
  function fade(opacity) {
    return function(d,i) {
      svg.selectAll("path.chord")
          .filter(function(d) { return d.source.index != i && d.target.index != i; })
      .transition()
          .style("opacity", opacity);
    };
  }//fade

</script>
{% endblock %}
